<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ductorix - Student Registration</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #F8F9FA; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            min-height: 100vh;
            overflow-x: hidden;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body::-webkit-scrollbar {
            display: none;
        }

        .container { 
            background-color: #E4E6EA; 
            padding: 2.5rem;
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            width: 100%; 
            max-width: 500px;
            text-align: center; 
        }

        h1 { 
            margin-bottom: 1rem; 
            color: #333; 
        }

        form { 
            display: flex; 
            flex-direction: column; 
            gap: 1rem; 
            text-align: left; 
        }

        label { 
            font-weight: bold; 
            margin-top: 15px;
            margin-bottom: 1px;
        }

        input { 
            padding: 0.75rem; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-size: 1rem; 
            width: 95%;
        }

        button { 
            margin-top: 15px;
            padding: 0.75rem; 
            background-color: #4267B2; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            font-size: 1rem; 
            cursor: pointer; 
        }

        .message { 
            margin-top: 1rem; 
            padding: 0.75rem; 
            border-radius: 4px; 
            font-weight: bold; 
            display: none; 
        }

        .error { 
            background-color: #f8d7da; 
            color: #721c24; 
        }

        .success { 
            background-color: #d4edda; 
            color: #155724; 
        }

        .info-text {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        footer {
            background-color:#4267B2; 
            color:#fff; 
            text-align:center; 
            padding:1.5rem; 
            font-size:0.9rem; 
            width: 100%;
        }
        
        .login-link {
            margin-top: 1rem;
            text-align: center;
        }
        
        .login-link a {
            color: #4267B2;
            text-decoration: none;
            font-weight: bold;
        }
        
        .login-link a:hover {
            text-decoration: underline;
        }

        .email-validation {
            position: relative;
        }

        .email-status {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        .email-available {
            color: #28a745;
        }

        .email-taken {
            color: #dc3545;
        }

        .login-button {
            color: #222;
            font-weight: bold;
            text-decoration: none;
        }
    </style>
</head>
<body style="margin: 0;">
    <div style="flex: 1; display: flex; justify-content: center; align-items: center; padding: 2rem;">
        <div class="container">
            <h1>Student Registration</h1>
            
            <div class="info-text">
                <strong>Note:</strong> After registering, you'll be prompted to join a class using a class code provided by your teacher.
            </div>
            
            <p class="message" id="regMessage"></p>
            <form id="regForm">
                <label for="fullName">Full Name (first last):</label>
                <input type="text" id="fullName" required>
                
                <label for="email">Email (Username):</label>
                <div class="email-validation">
                    <input type="email" id="email" required>
                    <span id="emailStatus" class="email-status"></span>
                </div>
                
                <label for="password">Password:</label>
                <input type="password" id="password" required>
                
                <button type="submit">Register</button>
            </form>
            
            <div class="login-link">
                <p class="login-button">Already have an account? <a href="/login.html">Login here</a></p>
            </div>
        </div>
    </div>
    <footer role="contentinfo">
        2025 Evan Beaulieu Production. All rights reserved.
        <div class="small-footer">
            <p>Ductorix.ai | Version 1</p>
            <p>Last Updated: July 2025 | Contact: <a href="contact.html" class="footer-link">Here</a></p>
        </div>
    </footer>
    <style>
        .small-footer {
            font-size: 0.9rem;
            color: #bbb;
            margin: 0;
            padding: 0;
        }

        .footer-link {
            color: #bbb;
            text-decoration: underline;
            font-style: italic;
        }
        footer {
            margin: 0 0px;
        }
    </style>

    <script>
        const API_BASE_URL = window.location.origin;
        const regForm = document.getElementById('regForm');
        const regMessage = document.getElementById('regMessage');
        let emailCheckTimeout;
        let isEmailAvailable = false;

        function displayMessage(element, msg, isError) {
            element.textContent = msg;
            element.className = `message ${isError ? 'error' : 'success'}`;
            element.style.display = 'block';
        }

        // Email availability check
        document.getElementById('email').addEventListener('input', function() {
            const email = this.value.trim();
            const emailStatus = document.getElementById('emailStatus');
            
            // Clear previous timeout
            clearTimeout(emailCheckTimeout);
            
            if (!email) {
                emailStatus.textContent = '';
                isEmailAvailable = false;
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                emailStatus.textContent = '';
                isEmailAvailable = false;
                return;
            }

            emailStatus.textContent = 'Checking...';
            emailStatus.className = 'email-status';
            
            // Debounce the API call
// Debounce the API call
            emailCheckTimeout = setTimeout(async () => {
                try {
                    const response = await fetch('/api/check-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email }),
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // CORRECTED: Check for !data.exists instead of data.available
                        if (!data.exists) {
                            emailStatus.textContent = '✓ Available';
                            emailStatus.className = 'email-status email-available';
                            isEmailAvailable = true;
                        } else {
                            emailStatus.textContent = '✗ Already taken';
                            emailStatus.className = 'email-status email-taken';
                            isEmailAvailable = false;
                        }
                    } else {
                        emailStatus.textContent = '';
                        isEmailAvailable = false;
                    }
                } catch (error) {
                    console.error('Error checking email:', error);
                    emailStatus.textContent = '';
                    isEmailAvailable = false;
                }
            }, 500); // 500ms delay
        });

        regForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            // Validate required fields
            if (!fullName || !email || !password) {
                displayMessage(regMessage, 'All fields are required.', true);
                return;
            }

            // Check if email is available
            if (!isEmailAvailable) {
                displayMessage(regMessage, 'Please use a different email address. This one is already taken or invalid.', true);
                return;
            }

            const payload = {
                fullName: fullName,
                email: email,
                password: password
            };

            try {
                const response = await fetch('/api/register-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await response.json();
                
                if (response.ok) {
                    displayMessage(regMessage, data.message + ' Redirecting to login...', false);
                    setTimeout(() => { window.location.href = '/login.html'; }, 2000);
                } else {
                    if (response.status === 409) {
                        displayMessage(regMessage, 'This email address is already in use. Please choose a different email.', true);
                    } else {
                        displayMessage(regMessage, data.error || 'Registration failed.', true);
                    }
                }
            } catch (error) {
                console.error('Network error:', error);
                displayMessage(regMessage, 'A network error occurred.', true);
            }
        });
    </script>
</body>
</html>